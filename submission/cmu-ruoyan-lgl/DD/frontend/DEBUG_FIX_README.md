# 🔧 DD 项目调试工具修复说明

## 🚨 问题描述

你遇到的错误 "Invalid projectId format in event args" 是因为合约事件中的 `projectId` 参数格式不正确导致的。这个问题通常发生在：

1. **ethers v5 兼容性问题** - 不同版本的 ethers 返回不同格式的事件参数
2. **BigNumber 格式转换失败** - 事件参数可能是 BigNumber 对象，需要正确转换
3. **事件解析逻辑不完整** - 缺少对不同数据类型的处理

## ✅ 修复内容

### 1. 添加了安全的事件参数解析函数

- `safeGetProjectId()` - 安全地转换 projectId 参数
- `safeGetProjectAddress()` - 安全地转换 projectAddress 参数

### 2. 支持的数据格式

这些函数现在可以处理以下格式的 projectId：

- ✅ **BigNumber 对象** - `{ _hex: '0x01', _isBigNumber: true }`
- ✅ **十六进制字符串** - `'0x01'`
- ✅ **十进制字符串** - `'1'`
- ✅ **数字类型** - `1`
- ✅ **BigInt 类型** - `BigInt(1)`
- ✅ **带 toString 的对象** - `{ toString: () => '1' }`

### 3. 替换了所有事件解析逻辑

更新了 `contractService.ts` 中所有的事件解析代码，使用新的安全函数：

- 方法 1: 从 `receipt.events` 查找
- 方法 2: 从 `receipt.events` 查找（替代格式）
- 方法 3: 从交易日志手动解析
- 方法 4: 从区块事件过滤器获取

## 🧪 测试方法

### 1. 运行事件解析测试

1. 打开调试页面
2. 点击 "🔍 运行事件解析测试" 按钮
3. 查看测试结果，确认所有格式都能正确转换

### 2. 测试项目创建

1. 使用你提供的数据：
   - name: `ruoyan`
   - contractAddress: `0x36c61b79b1e5c6A979CC3789640a878e65BC7500`
   - 其他字段: `https://www.bilibili.com/`

2. 运行诊断工具检查所有步骤

## 🔍 调试步骤

如果问题仍然存在，请按以下步骤调试：

### 1. 检查网络连接
- 确保连接到正确的网络（Sepolia 测试网）
- 确认钱包已连接

### 2. 运行完整诊断
- 使用调试工具运行 "🔍 运行诊断"
- 查看控制台输出的详细日志

### 3. 检查合约状态
- 确认合约地址正确
- 验证合约 ABI 是否匹配

### 4. 查看事件日志
- 检查交易收据中的事件
- 分析事件参数的格式

## 📋 常见问题

### Q: 为什么会出现这个错误？
A: 这通常是因为 ethers v5 返回的事件参数格式与代码期望的格式不匹配。

### Q: 修复后还会出现错误吗？
A: 修复后的代码应该能够处理所有常见的事件参数格式。如果仍有问题，可能是合约本身的问题。

### Q: 如何验证修复是否有效？
A: 运行事件解析测试，所有测试用例都应该成功通过。

## 🚀 下一步

1. **测试修复** - 运行事件解析测试
2. **尝试创建项目** - 使用你的数据重新测试
3. **监控日志** - 查看控制台输出，确认事件解析正常
4. **报告结果** - 如果问题解决，可以继续使用；如果仍有问题，请提供新的错误信息

---

**注意**: 这个修复主要解决了前端事件解析的问题。如果问题仍然存在，可能需要检查：
- 合约代码是否正确
- 网络配置是否正确
- 合约是否已正确部署
